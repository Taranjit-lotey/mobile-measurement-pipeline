version: 2

sources:
  - name: raw
    description: Raw mobile measurement data from GCS
    database: "{{ env_var('GCP_PROJECT_ID') }}"
    schema: "{{ env_var('BQ_DATASET', 'mobile_measurement') }}"
    tables:
      - name: mmp_events_external
        description: |
          External table pointing to GCS raw JSONL files.
          Contains unprocessed mobile measurement partner events.
        external:
          location: "gs://{{ env_var('GCS_BUCKET', 'mobile-measurement-data') }}/raw/*.jsonl"
          options:
            format: NEWLINE_DELIMITED_JSON
            hive_partition_uri_prefix: "gs://{{ env_var('GCS_BUCKET', 'mobile-measurement-data') }}/raw"
        columns:
          - name: event_id
            description: Unique identifier for each event
          - name: timestamp
            description: Event timestamp in ISO 8601 format
          - name: event_type
            description: Type of event (install, reinstall, click, impression)
          - name: partner
            description: Mobile measurement partner name
          - name: cost_usd
            description: Cost in USD for this event
          - name: app_id
            description: Application identifier
          - name: campaign_id
            description: Marketing campaign identifier
          - name: platform
            description: Mobile platform (iOS or Android)
          - name: country_code
            description: ISO country code

models:
  - name: stg_mmp_events
    description: |
      Cleaned and typed mobile measurement partner events.
      This staging model performs:
      - Type conversions (timestamp parsing, cost casting)
      - Normalization (lowercase event types, uppercase platforms)
      - Derived fields (date dimensions)
      - Data quality filters (non-null timestamps, non-negative costs)
    columns:
      - name: event_id
        description: Unique event identifier (UUID)
        tests:
          - unique
          - not_null

      - name: event_timestamp
        description: Parsed timestamp as TIMESTAMP type
        tests:
          - not_null

      - name: event_date
        description: Event date (derived from timestamp)
        tests:
          - not_null

      - name: event_type
        description: Normalized event type (lowercase)
        tests:
          - not_null
          - accepted_values:
              values: ['install', 'reinstall', 'click', 'impression']

      - name: partner
        description: MMP partner name (lowercase)
        tests:
          - not_null

      - name: cost_usd
        description: Event cost in USD (FLOAT64)
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"
              config:
                severity: warn

      - name: app_id
        description: Application identifier
        tests:
          - not_null

      - name: campaign_id
        description: Campaign identifier

      - name: platform
        description: Mobile platform (uppercase)
        tests:
          - not_null
          - accepted_values:
              values: ['IOS', 'ANDROID']

      - name: country_code
        description: ISO country code (uppercase)
        tests:
          - not_null

      - name: year
        description: Year extracted from timestamp
      - name: month
        description: Month extracted from timestamp
      - name: week
        description: Week number extracted from timestamp
      - name: day_of_week
        description: Day of week (1=Sunday, 7=Saturday)
